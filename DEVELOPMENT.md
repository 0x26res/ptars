# Development

Most of the development tasks are expressed in the [Makefile](./Makefile)

## Set up venv

```shell
make develop
```

### Special case for ARM mac

Add this to your bash/rc profile:

```shell
export CARGO_BUILD_TARGET=aarch64-apple-darwin
```

## Testing

```shell
cargo build && maturin develop && RUST_BACKTRACE=1 pytest python/test
```

## Releasing

### Using bump-my-version (recommended)

The project uses [bump-my-version](https://github.com/callowayproject/bump-my-version) to manage versioning across all files.

```shell
# Preview what would change (dry run)
uv run bump-my-version bump patch --dry-run --verbose --allow-dirty

# Bump patch version (0.0.9 -> 0.0.10)
uv run bump-my-version bump patch

# Bump minor version (0.0.9 -> 0.1.0)
uv run bump-my-version bump minor

# Bump major version (0.0.9 -> 1.0.0)
uv run bump-my-version bump major
```

This will automatically:

- Update version in `pyproject.toml`, `ptars/Cargo.toml`, and `ptars-python/Cargo.toml`
- Create a commit with the version bump
- Create a git tag with `v` prefix (e.g., `v0.0.10`)

After bumping, update lock files and push:

```shell
cargo generate-lockfile
uv lock
git add Cargo.lock uv.lock
git commit --amend --no-edit
git push origin main --tags
```

### Manual release (alternative)

- Update the version in `ptars/Cargo.toml` and `ptars-python/Cargo.toml`
- Update cargo lock file `cargo generate-lockfile`
- Update the version in `pyproject.toml`
- Update the uv lock file `uv lock`
- Update pre-commit checks `pre-commit autoupdate && pre-commit run --all-files`
- Tag and push the tag (don't forget to prepend a `v` to the version when tagging)

Note: the ci script is autogenerated:

```shell
make generate-ci
```

## Benchmarking

Make sure to install the release version of ptars.
The locally built version is much slower.

```shell
make benchmark
```

## TODO

- [ ] add configuration for enums, timestamp, date, wrapped types, duration

## Resources

- [Blog on how to develop](https://blog.yossarian.net/2020/08/02/Writing-and-publishing-a-python-module-in-rust?utm_source=pocket_saves)
  and [Corresponding repo](https://github.com/woodruffw/procmaps.py)
- [PyO3 get started](https://pyo3.rs/v0.4.1/) and  [Pyo3 with poetry](https://github.com/nbigaouette/python-poetry-rust-wheel/)
- [Maturin "Mixed Source"](https://www.maturin.rs/#mixed-rustpython-projects)
- [arrow builder example](https://github.com/apache/arrow-rs/blob/master/arrow/examples/builders.rs)
